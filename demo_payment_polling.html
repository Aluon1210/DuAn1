<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo - Thanh To√°n QR & Polling T·ª± ƒê·ªông</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section h2 {
            font-size: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        input,
        select,
        textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .qr-display {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            min-height: 250px;
            justify-content: center;
        }

        #qrCode {
            max-width: 200px;
            max-height: 200px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .status-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .status-box.success {
            background: #c8e6c9;
            border-left-color: #4caf50;
            color: #2e7d32;
        }

        .status-box.error {
            background: #ffcdd2;
            border-left-color: #f44336;
            color: #c62828;
        }

        .status-box.info {
            background: #bbdefb;
            border-left-color: #2196f3;
            color: #1565c0;
        }

        .status-box.warning {
            background: #ffe0b2;
            border-left-color: #ff9800;
            color: #e65100;
        }

        .status-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-message {
            font-size: 14px;
            word-break: break-word;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .controls button {
            flex: 1;
        }

        .info-box {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .polling-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .stat {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            text-transform: uppercase;
        }

        .json-display {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
        }

        .log-line {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .log-time {
            color: #999;
            font-size: 11px;
        }

        .log-message {
            color: #333;
        }

        .log-error {
            color: #f44336;
        }

        .log-success {
            color: #4caf50;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Thanh To√°n QR & Polling T·ª± ƒê·ªông</h1>
            <p>Demo h·ªá th·ªëng ki·ªÉm tra thanh to√°n v√† t·∫°o ƒë∆°n h√†ng t·ª± ƒë·ªông</p>
        </div>

        <div class="content">
            <!-- Ph·∫ßn tr√°i: QR Code & Th√¥ng tin -->
            <div class="section">
                <h2>üì± Th√¥ng Tin Thanh To√°n</h2>

                <div class="form-group">
                    <label>S·ªë ti·ªÅn (VND)</label>
                    <input type="number" id="amount" value="3200000" min="0" step="1000">
                </div>

                <div class="form-group">
                    <label>M√¥ t·∫£</label>
                    <input type="text" id="description" value="Thanh toan don hang - Tui Speedy Monogram">
                </div>

                <div class="form-group">
                    <label>M√£ ƒë∆°n h√†ng (Order ID)</label>
                    <input type="text" id="orderId" placeholder="ORD0000000001">
                </div>

                <button class="btn-primary" onclick="generateOrder()">üîÑ T·∫°o ƒê∆°n H√†ng M·ªõi</button>
                <button class="btn-secondary" onclick="generateQRCode()">üì≤ Generate QR Code</button>

                <div class="qr-display" id="qrDisplay">
                    <img id="qrCode" src="" alt="QR Code" style="display: none;">
                    <p style="color: #999;">QR Code s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                </div>

                <div class="info-box">
                    <strong>Th√¥ng tin ng√¢n h√†ng:</strong><br>
                    Ng√¢n h√†ng: <strong>MB Bank</strong><br>
                    S·ªë TK: <strong>0833268346</strong><br>
                    T√™n TK: <strong>DUONG THANH CONG</strong>
                </div>
            </div>

            <!-- Ph·∫ßn ph·∫£i: Polling & Status -->
            <div class="section">
                <h2>‚ö° Polling Thanh To√°n</h2>

                <button class="btn-primary" onclick="startPolling()">‚ñ∂Ô∏è B·∫Øt ƒê·∫ßu Polling</button>
                <button class="btn-danger" onclick="stopPolling()">‚èπÔ∏è D·ª´ng Polling</button>

                <div class="polling-stats">
                    <div class="stat">
                        <div class="stat-value" id="attemptCount">0</div>
                        <div class="stat-label">L·∫ßn Ki·ªÉm Tra</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="statusIcon">‚è≥</div>
                        <div class="stat-label">Tr·∫°ng Th√°i</div>
                    </div>
                </div>

                <div class="status-box" id="statusBox">
                    <div class="status-label">Tr·∫°ng th√°i</div>
                    <div class="status-message" id="statusMessage">S·∫µn s√†ng</div>
                </div>

                <h3 style="margin-top: 20px; font-size: 16px; color: #333;">üìù Log Activity</h3>
                <div class="json-display" id="logContainer">
                    <div class="log-line">
                        <span class="log-time">[S·∫µn s√†ng]</span>
                        <span class="log-message">H·ªá th·ªëng ƒëang ch·ªù...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Th∆∞ vi·ªán Polling -->
    <script src="/asset/js/payment-polling.js"></script>
    <script src="/asset/js/payment-status-handler.js"></script>

    <script>
        let currentPoller = null;
        let logLines = [];
        const MAX_LOGS = 50;

        // Kh·ªüi t·∫°o user ID
        const userId = 'demo_user_123';

        function generateOrder() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 10000);
            const orderId = `ORD${timestamp}${random}`;
            document.getElementById('orderId').value = orderId;
            addLog('INFO', `T·∫°o ƒë∆°n h√†ng m·ªõi: ${orderId}`);
        }

        function generateQRCode() {
            const amount = document.getElementById('amount').value;
            const description = document.getElementById('description').value;

            if (!amount || parseInt(amount) <= 0) {
                showStatus('error', 'Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá');
                return;
            }

            // VietQR format
            const bankId = 'MB';
            const accountNo = '0833268346';
            const template = 'print';

            const qrUrl = `https://img.vietqr.io/image/${bankId}-${accountNo}-${template}.png?amount=${amount}&addInfo=${encodeURIComponent(description)}`;

            const qrImg = document.getElementById('qrCode');
            qrImg.src = qrUrl;
            qrImg.style.display = 'block';

            showStatus('info', `QR Code ƒë∆∞·ª£c t·∫°o cho s·ªë ti·ªÅn: ${formatCurrency(parseInt(amount))}`);
            addLog('INFO', `Generate QR Code - Amount: ${amount} VND`);
        }

        function startPolling() {
            if (currentPoller && currentPoller.pollingActive) {
                showStatus('warning', 'Polling ƒë√£ ƒë∆∞·ª£c b·∫Øt ƒë·∫ßu');
                return;
            }

            const orderId = document.getElementById('orderId').value;
            if (!orderId) {
                showStatus('error', 'Vui l√≤ng t·∫°o ƒë∆°n h√†ng tr∆∞·ªõc');
                return;
            }

            const amount = parseInt(document.getElementById('amount').value);
            const description = document.getElementById('description').value;

            currentPoller = PaymentPoller.startPolling({
                orderId: orderId,
                pollingInterval: 2000,
                maxAttempts: 300,  // 10 ph√∫t demo
                autoCreateOrder: true,

                onPollingStart: (data) => {
                    showStatus('info', data.message + ' - ' + data.orderId);
                    addLog('START', `Polling b·∫Øt ƒë·∫ßu cho ƒë∆°n h√†ng: ${data.orderId}`);
                    updateUI();
                },

                onPaymentDetected: (data) => {
                    showStatus('info', data.message);
                    const payment = data.payment;
                    const paymentStr = JSON.stringify(payment, null, 2);
                    addLog('DETECT', `Ph√°t hi·ªán thanh to√°n:\n${paymentStr}`);
                    updateUI();
                },

                onPaymentCheck: (data) => {
                    // Update UI m·ªói l·∫ßn check (t√πy ch·ªçn)
                    updateUI();
                    
                    // N·∫øu c√≥ error message, hi·ªÉn th·ªã th√¥ng b√°o
                    if (data.response && !data.response.success && data.attempts % 10 === 0) {
                        // M·ªói 10 l·∫ßn check, c·∫≠p nh·∫≠t log
                        addLog('CHECK', `L·∫ßn ${data.attempts}: ${data.message}`);
                    }
                },

                onSuccess: (data) => {
                    showStatus('success', `‚úì ${data.message}\nM√£ ƒë∆°n h√†ng: ${data.orderId}`);
                    addLog('SUCCESS', `ƒê∆°n h√†ng t·∫°o th√†nh c√¥ng: ${data.orderId}`);
                    
                    // S·ª≠ d·ª•ng PaymentStatusHandler ƒë·ªÉ hi·ªÉn th·ªã modal
                    const statusInfo = PaymentStatusHandler.handlePollingResponse({
                        success: true,
                        message: data.message,
                        order_id: data.orderId,
                        payment: data.payment,
                        order_data: data.orderData
                    });
                    
                    PaymentStatusHandler.showNotificationModal(statusInfo);
                    stopPolling();
                    updateUI();
                },

                onError: (data) => {
                    showStatus('error', `‚úó ${data.message}`);
                    addLog('ERROR', data.message);
                    updateUI();
                },

                onPollingStop: (data) => {
                    showStatus('info', `D·ª´ng polling sau ${data.attempts} l·∫ßn ki·ªÉm tra`);
                    addLog('STOP', `Polling d·ª´ng - L·∫ßn ki·ªÉm tra: ${data.attempts}`);
                    updateUI();
                }
            });
        }

        function stopPolling() {
            if (currentPoller) {
                currentPoller.stop();
                updateUI();
            }
        }

        function showStatus(type, message) {
            const box = document.getElementById('statusBox');
            const msg = document.getElementById('statusMessage');

            box.className = `status-box ${type}`;
            msg.textContent = message;

            const typeLabel = {
                'success': '‚úì Th√†nh c√¥ng',
                'error': '‚úó L·ªói',
                'warning': '‚ö†Ô∏è C·∫£nh b√°o',
                'info': '‚ÑπÔ∏è Th√¥ng tin'
            };

            document.querySelector('.status-label').textContent = typeLabel[type] || type;
        }

        function addLog(type, message) {
            const time = new Date().toLocaleTimeString('vi-VN');
            logLines.push({ time, type, message });

            if (logLines.length > MAX_LOGS) {
                logLines.shift();
            }

            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '';

            logLines.forEach(log => {
                const line = document.createElement('div');
                line.className = 'log-line';

                let typeColor = '';
                if (log.type === 'ERROR') typeColor = 'log-error';
                else if (log.type === 'SUCCESS') typeColor = 'log-success';

                line.innerHTML = `
                    <span class="log-time">[${log.time}] ${log.type}</span>
                    <span class="log-message ${typeColor}" style="display: block; margin-top: 3px; white-space: pre-wrap; word-break: break-word;">
                        ${log.message}
                    </span>
                `;
                container.appendChild(line);
            });

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function updateUI() {
            if (!currentPoller) return;

            document.getElementById('attemptCount').textContent = currentPoller.attempts;

            const icon = currentPoller.pollingActive ? '‚úì' : '‚è∏Ô∏è';
            const status = currentPoller.pollingActive ? 'ƒêang polling...' : 'ƒê√£ d·ª´ng';
            document.getElementById('statusIcon').textContent = icon;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Initialize
        generateOrder();
        generateQRCode();

        addLog('INFO', '·ª®ng d·ª•ng demo ƒë√£ s·∫µn s√†ng');
        addLog('INFO', 'B∆∞·ªõc 1: Generate QR Code');
        addLog('INFO', 'B∆∞·ªõc 2: Click "B·∫Øt ƒê·∫ßu Polling"');
        addLog('INFO', 'B∆∞·ªõc 3: ƒê·ª£i ph√°t hi·ªán thanh to√°n');
    </script>
</body>
</html>
