# ğŸ¯ Luá»“ng Xá»­ LÃ½ Thanh ToÃ¡n QR & Táº¡o ÄÆ¡n HÃ ng

## SÆ¡ Äá»“ Luá»“ng Chi Tiáº¿t

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHECKOUT PAGE (CheckoutConfirm)              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“¦ GIá» HÃ€NG                                              â”‚ â”‚
â”‚  â”‚ â”œâ”€ Sáº£n pháº©m 1: 500,000 VND Ã— 2 = 1,000,000 VND         â”‚ â”‚
â”‚  â”‚ â”œâ”€ Sáº£n pháº©m 2: 250,000 VND Ã— 2 = 500,000 VND           â”‚ â”‚
â”‚  â”‚ â””â”€ Tá»”NG: 1,500,000 VND                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“ THÃ”NG TIN GIAO HÃ€NG                                   â”‚ â”‚
â”‚  â”‚ â”œâ”€ Äá»‹a chá»‰: [123 ÄÆ°á»ng ABC, Q.1, TP.HCM]               â”‚ â”‚
â”‚  â”‚ â””â”€ Ghi chÃº: [Giao chiá»u]                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ’³ PHÆ¯Æ NG THá»¨C THANH TOÃN                                â”‚ â”‚
â”‚  â”‚ âš« Chuyá»ƒn khoáº£n QR                                        â”‚ â”‚
â”‚  â”‚ âšª Thanh toÃ¡n khÃ¡c                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”‘ BUTTONS                                               â”‚ â”‚
â”‚  â”‚ [Kiá»ƒm Tra Thanh ToÃ¡n] [Táº¡o ÄÆ¡n HÃ ng]                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  USER QUÃ‰T QR & THANH TOÃN TRÃŠN      â”‚
        â”‚  NGÃ‚N HÃ€NG (NgoÃ i há»‡ thá»‘ng)          â”‚
        â”‚                                       â”‚
        â”‚  ğŸ”„ Giao dá»‹ch Ä‘ang xá»­ lÃ½...          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  CLICK "Kiá»ƒm Tra Thanh ToÃ¡n"           â”‚
        â”‚                                       â”‚
        â”‚  POST /payment/check-payment          â”‚
        â”‚  {                                    â”‚
        â”‚    order_id: "TMP123456",             â”‚
        â”‚    amount: 1500000,                   â”‚
        â”‚    description: "Thanh toan...",      â”‚
        â”‚    account_no: "0123456789",          â”‚
        â”‚    bank_id: "ACB"                     â”‚
        â”‚  }                                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ API KIá»‚M TRA (PaymentController)            â”‚
        â”‚                                             â”‚
        â”‚ Gá»i Google Apps Script API                 â”‚
        â”‚ TÃ¬m kiáº¿m giao dá»‹ch khá»›p:                  â”‚
        â”‚ â€¢ Amount: 1,500,000 âœ“                     â”‚
        â”‚ â€¢ Description: Khá»›p âœ“                      â”‚
        â”‚ â€¢ Account: Khá»›p âœ“                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    Giao dá»‹ch tÃ¬m tháº¥y?
                    /            \
                   YES            NO
                  /                \
                 â†“                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ âœ… ThÃ nh cÃ´ngâ”‚    â”‚ âŒ Tháº¥t báº¡i     â”‚
        â”‚ success: trueâ”‚    â”‚ success: false  â”‚
        â”‚ transaction: â”‚    â”‚ message: "ChÆ°a â”‚
        â”‚   {...}      â”‚    â”‚ phÃ¡t hiá»‡n..."  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                   â”‚
                 â†“                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  [Hiá»ƒn thá»‹ lá»—i]
        â”‚ âœ… ENABLED       â”‚  [Thá»­ láº¡i]
        â”‚ NÃºt "Táº¡o ÄÆ¡n   â”‚
        â”‚ HÃ ng" xuáº¥t hiá»‡n  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ CLICK "Táº¡o ÄÆ¡n HÃ ng" (NEW!)       â”‚
        â”‚                                  â”‚
        â”‚ POST /payment/create-order-on-   â”‚
        â”‚     payment                      â”‚
        â”‚ {                                â”‚
        â”‚   amount: 1500000,               â”‚
        â”‚   address: "123 ABC, Q.1, ...",  â”‚
        â”‚   note: "Giao chiá»u",            â”‚
        â”‚   description: "Thanh toÃ¡n..."   â”‚
        â”‚ }                                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ BACKEND Xá»¬ LÃ                      â”‚
        â”‚ (createOrderOnPayment)             â”‚
        â”‚                                  â”‚
        â”‚ 1ï¸âƒ£ Validate dá»¯ liá»‡u              â”‚
        â”‚    â”œâ”€ amount > 0? âœ“             â”‚
        â”‚    â””â”€ address? âœ“                â”‚
        â”‚                                  â”‚
        â”‚ 2ï¸âƒ£ Láº¥y giá» hÃ ng tá»« DB           â”‚
        â”‚    â”œâ”€ Sáº£n pháº©m 1: âœ“             â”‚
        â”‚    â””â”€ Sáº£n pháº©m 2: âœ“             â”‚
        â”‚                                  â”‚
        â”‚ 3ï¸âƒ£ Validate tá»“n kho             â”‚
        â”‚    â”œâ”€ Sáº£n pháº©m 1: Stock OK âœ“   â”‚
        â”‚    â””â”€ Sáº£n pháº©m 2: Stock OK âœ“   â”‚
        â”‚                                  â”‚
        â”‚ 4ï¸âƒ£ TÃ­nh tá»•ng tiá»n               â”‚
        â”‚    â””â”€ 1,500,000 = amount? âœ“    â”‚
        â”‚                                  â”‚
        â”‚ 5ï¸âƒ£ Táº¡o Ä‘Æ¡n hÃ ng                 â”‚
        â”‚    â”œâ”€ Order_Id: Ord0000000001  â”‚
        â”‚    â”œâ”€ Status: pending           â”‚
        â”‚    â””â”€ User_Id: user123          â”‚
        â”‚                                  â”‚
        â”‚ 6ï¸âƒ£ Táº¡o chi tiáº¿t Ä‘Æ¡n hÃ ng        â”‚
        â”‚    â”œâ”€ Item 1: Sáº£n pháº©m 1        â”‚
        â”‚    â””â”€ Item 2: Sáº£n pháº©m 2        â”‚
        â”‚                                  â”‚
        â”‚ 7ï¸âƒ£ XÃ³a giá» hÃ ng                 â”‚
        â”‚    â”œâ”€ Item 1: âœ— XÃ³a             â”‚
        â”‚    â””â”€ Item 2: âœ— XÃ³a             â”‚
        â”‚                                  â”‚
        â”‚ 8ï¸âƒ£ Return response              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
            Response?
            /       \
           OK        ERROR
          /           \
         â†“             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ… 201  â”‚   â”‚ âŒ 400/401   â”‚
    â”‚ Created â”‚   â”‚ /500         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚
         â†“            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” [Hiá»ƒn thá»‹ lá»—i]
    â”‚ {            â”‚
    â”‚   success:   â”‚
    â”‚   true,      â”‚
    â”‚   order_id:  â”‚
    â”‚   "Ord...",  â”‚
    â”‚   order_data â”‚
    â”‚ }            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ‰ SUCCESS MODAL    â”‚
    â”‚                     â”‚
    â”‚ âœ“ ÄÆ¡n hÃ ng Ä‘Æ°á»£c    â”‚
    â”‚   táº¡o thÃ nh cÃ´ng!   â”‚
    â”‚                     â”‚
    â”‚ Order ID:           â”‚
    â”‚ Ord0000000001       â”‚
    â”‚                     â”‚
    â”‚ Items: 2            â”‚
    â”‚ Total: 1,500,000 Ä‘  â”‚
    â”‚                     â”‚
    â”‚ Äang chuyá»ƒn         â”‚
    â”‚ hÆ°á»›ng...            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€ 2 giÃ¢y
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ORDER DETAIL PAGE           â”‚
    â”‚ /order/Ord0000000001       â”‚
    â”‚                             â”‚
    â”‚ âœ“ ÄÆ¡n hÃ ng #Ord0000000001   â”‚
    â”‚ âœ“ Tráº¡ng thÃ¡i: pending       â”‚
    â”‚ âœ“ Tá»•ng tiá»n: 1,500,000 Ä‘   â”‚
    â”‚ âœ“ Äá»‹a chá»‰: 123 ABC, Q.1    â”‚
    â”‚ âœ“ NgÃ y táº¡o: 2025-12-09     â”‚
    â”‚                             â”‚
    â”‚ [Quay láº¡i] [Theo dÃµi]      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Quy TrÃ¬nh Chi Tiáº¿t

### Phase 1ï¸âƒ£: Thanh ToÃ¡n QR (User)

```
User chá»n QR
    â†“
Hiá»ƒn thá»‹ QR Code
    â†“
User quÃ©t QR trÃªn ngÃ¢n hÃ ng
    â†“
User nháº­p sá»‘ tiá»n & xÃ¡c nháº­n
    â†“
Giao dá»‹ch Ä‘Æ°á»£c ngÃ¢n hÃ ng xá»­ lÃ½
    â†“
Tiá»n Ä‘Æ°á»£c chuyá»ƒn (Google Apps Script ghi nháº­n)
```

### Phase 2ï¸âƒ£: Kiá»ƒm Tra Giao Dá»‹ch (API)

```
POST /payment/check-payment
    â†“
Gá»i Google Apps Script
    â†“
TÃ¬m giao dá»‹ch vá»›i:
  â€¢ Amount = 1,500,000
  â€¢ Description match
  â€¢ Account match
    â†“
TÃ¬m tháº¥y?
  YES â†’ success: true
  NO  â†’ success: false
```

### Phase 3ï¸âƒ£: Táº¡o ÄÆ¡n HÃ ng (API - NEW!)

```
POST /payment/create-order-on-payment
    â†“
Validate:
  â€¢ amount > 0?
  â€¢ address?
  â€¢ user logged in?
    â†“
Láº¥y giá» hÃ ng tá»« DB
    â†“
Kiá»ƒm tra tá»“n kho tá»«ng item
    â†“
TÃ­nh tá»•ng tiá»n
    â†“
So sÃ¡nh: Total = amount?
    â†“
Táº¡o Order record
    â†“
Táº¡o OrderDetail items
    â†“
XÃ³a Cart items
    â†“
Return Order ID
```

### Phase 4ï¸âƒ£: XÃ¡c Nháº­n (Frontend)

```
Hiá»ƒn thá»‹ Success Modal
    â†“
ThÃ´ng tin Order:
  â€¢ Order ID
  â€¢ Items count
  â€¢ Total amount
    â†“
Delay 2 giÃ¢y
    â†“
Redirect â†’ /order/{order_id}
```

---

## State Flow Diagram

```
                           START
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Checkout Pageâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                   Has Cart? & Logged In?
                    /              \
                  YES               NO
                 /                   \
                â†“                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Show Cart   â”‚      â”‚ Redirect to   â”‚
        â”‚ Items       â”‚      â”‚ Login         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Fill Shipping Info  â”‚
        â”‚ â€¢ Address *         â”‚
        â”‚ â€¢ Note              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Select QR Payment   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Show QR Code        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ User Scans & Pays   â”‚
        â”‚ (Outside System)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Check Payment API   â”‚ â†’ /payment/check-payment
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
            Found?
            /    \
          YES    NO
         /        \
        â†“         â†“
    â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ…  â”‚  â”‚ âŒ Retry â”‚
    â”‚ Ok  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”˜       â†‘
        â†“         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Create Order API Button â”‚
    â”‚ (NOW ENABLED!)          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Create Order API     â”‚ â†’ /payment/create-order-on-payment
    â”‚ â€¢ Validate data      â”‚
    â”‚ â€¢ Check stock        â”‚
    â”‚ â€¢ Create order       â”‚
    â”‚ â€¢ Clear cart         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    Success?
    /       \
   YES      NO
  /          \
 â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ…   â”‚  â”‚ âŒ Show  â”‚
â”‚ 201  â”‚  â”‚ Error    â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Show Success     â”‚
â”‚ Modal            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redirect to      â”‚
â”‚ Order Details    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
 END
```

---

## Database Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE (Before Create Order)                  â”‚
â”‚                                                 â”‚
â”‚ CART TABLE:                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ | _Cart_Id | User_Id | Variant_Id | Quantity | â”‚
â”‚ |----------|---------|------------|----------|  â”‚
â”‚ | C001     | user123 | 100        | 2        |  â”‚
â”‚ | C002     | user123 | 101        | 2        |  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                 â”‚
â”‚ ORDERS TABLE: (Empty)                          â”‚
â”‚ ORDERDETAIL TABLE: (Empty)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ API createOrderOnPayment  â”‚
        â”‚ Processes...              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE (After Create Order)                   â”‚
â”‚                                                 â”‚
â”‚ ORDERS TABLE:                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ | Order_Id | User_Id | Status | Address | ..| â”‚
â”‚ |----------|---------|--------|---------|--| â”‚
â”‚ | Ord...01 | user123 | pending | 123 ABC| ..â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚ ORDERDETAIL TABLE:                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ | OrderDetail_Id | Order_Id | Variant_Id | Q | â”‚
â”‚ |----------------|----------|------------|--| â”‚
â”‚ | OD001          | Ord...01  | 100        | 2â”‚ â”‚
â”‚ | OD002          | Ord...01  | 101        | 2â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                 â”‚
â”‚ CART TABLE: (XÃ³a sáº¡ch)                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ | Empty                                       | â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Request/Response Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT (Browser/JavaScript)                        â”‚
â”‚                                                   â”‚
â”‚ PaymentIntegration.createOrderAfterPayment()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ fetch('/payment/...')        â”‚
        â”‚ POST                         â”‚
        â”‚ Content-Type: application/   â”‚
        â”‚ json                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                    REQUEST
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ JSON Body:                   â”‚
        â”‚ {                            â”‚
        â”‚   amount: 1500000,           â”‚
        â”‚   address: "123 ABC...",     â”‚
        â”‚   note: "Giao chiá»u"         â”‚
        â”‚ }                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ APACHE/PHP Server                    â”‚
        â”‚                                     â”‚
        â”‚ Route: /payment/create-order-on-    â”‚
        â”‚        payment                      â”‚
        â”‚ â†“                                   â”‚
        â”‚ PaymentController@                  â”‚
        â”‚   createOrderOnPayment()            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Processing:                          â”‚
        â”‚ â€¢ Parse JSON                         â”‚
        â”‚ â€¢ Validate request                   â”‚
        â”‚ â€¢ Query Cart from DB                 â”‚
        â”‚ â€¢ Check inventory                    â”‚
        â”‚ â€¢ Create Order                       â”‚
        â”‚ â€¢ Create OrderDetails                â”‚
        â”‚ â€¢ Delete Cart items                  â”‚
        â”‚ â€¢ Build response                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                    RESPONSE
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ HTTP Status: 201 Created     â”‚
        â”‚                              â”‚
        â”‚ JSON Body:                   â”‚
        â”‚ {                            â”‚
        â”‚   success: true,             â”‚
        â”‚   order_id: "Ord...",        â”‚
        â”‚   order_data: {...},         â”‚
        â”‚   items_count: 2,            â”‚
        â”‚   total_amount: 1500000      â”‚
        â”‚ }                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ CLIENT (Browser)             â”‚
        â”‚                              â”‚
        â”‚ result = response.json()     â”‚
        â”‚ if (result.success) {        â”‚
        â”‚   showSuccess(result)        â”‚
        â”‚   setTimeout(redirect, 2000) â”‚
        â”‚ }                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ DISPLAY SUCCESS MODAL        â”‚
        â”‚                              â”‚
        â”‚ âœ“ Order ID: Ord...          â”‚
        â”‚ âœ“ Items: 2                   â”‚
        â”‚ âœ“ Total: 1,500,000 Ä‘         â”‚
        â”‚                              â”‚
        â”‚ Redirecting in 2 seconds...  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ REDIRECT                     â”‚
        â”‚                              â”‚
        â”‚ window.location.href =       â”‚
        â”‚   '/order/Ord...'            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ORDER DETAIL PAGE            â”‚
        â”‚                              â”‚
        â”‚ Hiá»ƒn thá»‹ thÃ´ng tin Ä‘Æ¡n hÃ ng  â”‚
        â”‚ â€¢ Order ID                   â”‚
        â”‚ â€¢ Status: pending            â”‚
        â”‚ â€¢ Items list                 â”‚
        â”‚ â€¢ Total: 1,500,000 Ä‘         â”‚
        â”‚ â€¢ Address: 123 ABC           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Äiá»ƒm Quyáº¿t Äá»‹nh (Decision Points)

```
1ï¸âƒ£ User logged in?
   YES â†’ Continue
   NO  â†’ Redirect to /login

2ï¸âƒ£ Cart is empty?
   YES â†’ Error: "Giá» hÃ ng trá»‘ng"
   NO  â†’ Continue

3ï¸âƒ£ Address provided?
   YES â†’ Continue
   NO  â†’ Error: "address lÃ  báº¯t buá»™c"

4ï¸âƒ£ Amount > 0?
   YES â†’ Continue
   NO  â†’ Error: "amount lÃ  báº¯t buá»™c"

5ï¸âƒ£ Stock available?
   YES â†’ Continue
   NO  â†’ Error: "Sáº£n pháº©m háº¿t hÃ ng"

6ï¸âƒ£ Total = Amount?
   YES â†’ Continue
   NO  â†’ Error: "Tá»•ng tiá»n khÃ´ng khá»›p"

7ï¸âƒ£ Order created?
   YES â†’ Delete cart â†’ Success
   NO  â†’ Error: "Lá»—i táº¡o Ä‘Æ¡n hÃ ng"
```
